<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; text-align: center; }
        input, button { margin: 10px; padding: 5px; }
        #adminPanel { display: none; }
        #userInfo { margin-top: 20px; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; }
        #gameTime { font-size: 24px; color: #ffd700; }
        #transactionResult { margin-top: 10px; color: #ffd700; }
    </style>
</head>
<body>
    <h1>Admin Panel</h1>
    <input type="password" id="adminPass" placeholder="Admin Password">
    <button onclick="loginAdmin()">Login</button>
    <div id="adminPanel">
        <h2>အသုံးပြုသူ စစ်ဆေးမည်</h2>
        <input type="text" id="searchPhone" placeholder="ဖုန်းနံပါတ်ရှာ">
        <button onclick="searchUser()">ရှာမည်</button>
        <div id="userInfo"></div>

        <h2>ငွေသွင်း/ငွေထုတ်</h2>
        <input type="text" id="transactionPhone" placeholder="ဖုန်းနံပါတ်">
        <input type="number" id="transactionAmount" placeholder="ငွေပမာဏ (MMK)">
        <button onclick="deposit()">ငွေသွင်းမည်</button>
        <button onclick="withdraw()">ငွေထုတ်မည်</button>
        <div id="transactionResult"></div>

        <div>
            <p>Game Time: <span id="gameTime">30</span> စက္ကန့်</p>
            <button onclick="startGame()">Game ဖွင့်မည်</button>
            <button onclick="stopGame()">Game ပိတ်မည်</button>
        </div>
    </div>
    <script>
        let users = {};
        let adminLoggedIn = false;
        let gameActive = false;
        let adminPassword = "admin123";

        async function fetchUsers() {
            try {
                const response = await fetch('https://casinommr.netlify.app/api/data');
                users = await response.json();
                return users;
            } catch (error) {
                console.error('Error fetching users:', error);
                return {};
            }
        }

        async function updateUserData(phone, userData) {
            try {
                await fetch('https://casinommr.netlify.app/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, userData }),
                });
            } catch (error) {
                console.error('Error updating user data:', error);
            }
        }

        async function updateUserBalance(phone, balance) {
            try {
                await fetch('https://casinommr.netlify.app/api/data', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, balance }),
                });
                window.postMessage({ type: 'updateBalance', phone: phone }, '*');
            } catch (error) {
                console.error('Error updating user balance:', error);
            }
        }

        function loginAdmin() {
            if (document.getElementById('adminPass').value === adminPassword) {
                adminLoggedIn = true;
                document.getElementById('adminPanel').style.display = 'block';
                syncGameTime();
            } else {
                alert('Admin Password မမှန်ပါ');
            }
        }

        async function searchUser() {
            if (!adminLoggedIn) return;
            const phone = document.getElementById('searchPhone').value;
            await fetchUsers();
            if (users[phone]) {
                document.getElementById('userInfo').innerHTML = `
                    <p>Phone: ${phone}</p>
                    <p>Balance: ${users[phone].balance} MMK</p>
                    <p>Game ID: ${users[phone].gameId}</p>
                    <p>Play Time: ${users[phone].playTime} ကြိမ်</p>
                    <p>Last Activity: ${new Date(users[phone].lastActivity).toLocaleString()}</p>
                    <p>History: ${JSON.stringify(users[phone].history)}</p>
                `;
                window.postMessage({ type: 'updateUserInfo', phone: phone }, '*');
            } else {
                document.getElementById('userInfo').innerHTML = `<p>အသုံးပြုသူ မတွေ့ပါ</p>`;
            }
        }

        async function deposit() {
            if (!adminLoggedIn) return;
            const phone = document.getElementById('transactionPhone').value;
            const amount = parseInt(document.getElementById('transactionAmount').value);
            await fetchUsers();
            if (phone && amount > 0 && users[phone]) {
                users[phone].balance += amount;
                users[phone].history.push({ date: new Date().toISOString(), activity: `Deposited: ${amount} MMK by Admin` });
                await updateUserData(phone, users[phone]);
                await updateUserBalance(phone, users[phone].balance);
                document.getElementById('transactionResult').innerHTML = `<p>${amount} MMK ငွေသွင်းပြီးပါတယ် (အချိန်: ${new Date().toLocaleString()})</p>`;
                window.postMessage({ type: 'updateUserInfo', phone: phone }, '*');
            } else if (!users[phone]) {
                document.getElementById('transactionResult').innerHTML = `<p>ဖုန်းနံပါတ် ${phone} မတွေ့ပါ</p>`;
            } else {
                document.getElementById('transactionResult').innerHTML = `<p>မမှန်တဲ့ ငွေပမာဏ သို့မဟုတ် ဖုန်းနံပါတ်</p>`;
            }
        }

        async function withdraw() {
            if (!adminLoggedIn) return;
            const phone = document.getElementById('transactionPhone').value;
            const amount = parseInt(document.getElementById('transactionAmount').value);
            await fetchUsers();
            if (phone && amount > 0 && users[phone] && users[phone].balance >= amount) {
                users[phone].balance -= amount;
                users[phone].history.push({ date: new Date().toISOString(), activity: `Withdrawn: ${amount} MMK by Admin` });
                await updateUserData(phone, users[phone]);
                await updateUserBalance(phone, users[phone].balance);
                document.getElementById('transactionResult').innerHTML = `<p>${amount} MMK ငွေထုတ်ပြီးပါတယ် (အချိန်: ${new Date().toLocaleString()})</p>`;
                window.postMessage({ type: 'updateUserInfo', phone: phone }, '*');
            } else if (!users[phone]) {
                document.getElementById('transactionResult').innerHTML = `<p>ဖုန်းနံပါတ် ${phone} မတွေ့ပါ</p>`;
            } else if (users[phone].balance < amount) {
                document.getElementById('transactionResult').innerHTML = `<p>လက်ကျန်ငွေ မလုံလောက်ပါ</p>`;
            } else {
                document.getElementById('transactionResult').innerHTML = `<p>မမှန်တဲ့ ငွေပမာဏ သို့မဟုတ် ဖုန်းနံပါတ်</p>`;
            }
        }

        function syncGameTime() {
            let time = setInterval(() => {
                if (gameActive) {
                    let gameTimeElement = document.getElementById('gameTime');
                    let gameTimeValue = parseInt(gameTimeElement.innerText);
                    gameTimeValue--;
                    gameTimeElement.innerText = gameTimeValue;
                    if (gameTimeValue <= 0) {
                        gameTimeElement.innerText = 30;
                    }
                    window.postMessage({ type: 'syncTime', time: gameTimeValue }, '*');
                }
            }, 1000);
        }

        function startGame() {
            if (!adminLoggedIn) return;
            gameActive = true;
            document.getElementById('gameTime').innerText = 30;
            window.postMessage({ type: 'startGame', password: adminPassword }, 'https://casinommr.netlify.app');
            alert('Game စတင်ပါတယ်');
        }

        function stopGame() {
            if (!adminLoggedIn) return;
            gameActive = false;
            window.postMessage({ type: 'stopGame', password: adminPassword }, 'https://casinommr.netlify.app');
            alert('Game ပိတ်ပါတယ်');
        }

        window.addEventListener('message', async (event) => {
            if (event.data.type === 'updateBalance' && users[event.data.phone]) {
                await fetchUsers();
            }
        });
    </script>
</body>
</html>
